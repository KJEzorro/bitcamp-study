<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>Todo</title>
  <style>
    .todo-checked {
      text-decoration: line-through;
      background-color: yellow;
    }
  </style>
</head>

<body>
  <h1>Todo</h1>
  <a href="form.html">추가</a>
  <table id="x-todo-table" border="1">
    <thead>
      <tr>
        <th></th>
        <th>해야 할 일</th>
        <th>변경</th>
        <th>삭제</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>

  <input type="text" id="x-title-input">

  <script type="text/javascript">
  "use strict"

    var titleInput = document.querySelector("#x-title-input")
    // titleInput.style["display"] = "none"
    var tbody = document.querySelector("#x-todo-table tbody")

    /*
        // 삭제 버튼을 클릭 했을 때 호출될 리스너 등록하기
        // => 삭제 버튼은 동적으로 생성된다.
        // => 따라서 부모 태그에 리스너를 등록해야 한다.
        tbody.onclick = function(e) {
          // if (e.target.localName == "button") { // 아래 방법이나 이 방법 중 아무거나 사용해도 괜찮다.
          if (e.target instanceof HTMLButtonElement) {
            var no = e.target.getAttribute("data-no")
            fetch(`/todo/delete?index=${no}`)
              .then(function(response) {
                return response.json();
              })
              .then(function(result) {
                if (result == 0) {
                  alert("삭제하지 못했습니다.")
                } else {
                  location.reload() // 새로고침 refresh와 같다.
                }
              });
          }
        }
    */
    fetch("/todo/list")
      .then(function(response) {
        return response.json();
      })
      .then(function(todoList) {
        console.log(todoList);
        for (var i = 0; i < todoList.length; i++) {
          var tr = document.createElement("tr");
          var checkedOption = ""
          var titleTdOption = ""
          if (todoList[i].done) {
            checkedOption = "checked"
            titleTdOption = "class='todo-checked'"
          }

          tr.innerHTML = `
          <td><input type="checkbox" ${checkedOption} onchange="checkTodo(${i}, event.target.checked)"></td>
          <td data-no="${i}" ${titleTdOption}><span>${todoList[i].title}</span></td>
          <td><button type="button" onclick="updateTodo(${i})">변경</td>
          <td><button type="button" onclick="deleteTodo(${i})">삭제</td>`
          tbody.appendChild(tr);
        }
      });

    function deleteTodo(no) {
      fetch(`/todo/delete?index=${no}`)
        .then(function(response) {
          return response.json();
        })
        .then(function(result) {
          if (result == 0) {
            alert("삭제하지 못했습니다.")
          } else {
            location.reload() // 새로고침 refresh와 같다.
          }
        });
    }

    function checkTodo(no, checked) {
      console.log(no, checked);
      fetch(`/todo/check?index=${no}&done=${checked}`)
        .then(function(response) {
          return response.json();
        })
        .then(function(result) {
          if (result == 0) {
            alert("변경하지 못했습니다.")
          } else {
            var titleTd = document.querySelector(`tbody td[data-no="${no}"]`)
            if (checked) {
              titleTd.classList.add("todo-checked")
            } else {
              titleTd.classList.remove("todo-checked")
            }
            /*
            checked == true ?
            titleTd.style["text-decoration"] = "line-through" : titleTd.style["text-decoration"] = "none"
            */

          }
        });
    }

    function updateTodo(no) {

      // 현재 Todo 항목을 편집 중인 상태에서 변경 버튼을 눌렀다면
      if (titleInput.parentNode instanceof HTMLTableCellElement) {
        // 다른 항목을 편집하기 위해 이동하기 전에 편집 전의 상태로 되돌린다.
        titleInput.parentNode.querySelector("span").style["display"] = ""
      }
      var titleTd = document.querySelector(`tbody td[data-no="${no}"]`)
      var titleSpan = titleTd.querySelector("span")
      titleSpan.style["display"] = "none"
      titleInput.value = titleSpan.innerHTML
      titleTd.appendChild(titleInput)
    }

    titleInput.onkeyup = function(e) {
      var no = titleInput.parentNode.getAttribute("data-no")
      var originTitle = titleInput.parentNode.querySelector("span").innerHTML
      if (event.key === "Enter" /* 아니면 e.keyCode == 13 */ && titleInput.value != "" &&
        originTitle != titleInput.value) {
        fetch(`/todo/update?index=${no}&title=${titleInput.value}`)
          .then(function(response) {
            return response.json();
          })
          .then(function(result) {
            if (result == 0) {
              alert("변경하지 못했습니다.")
            } else {
              titleInput.parentNode.querySelector("span").innerHTML = titleInput.value
              titleInput.parentNode.querySelector("span").style["display"] = ""
              titleInput.style["display"] = "none"
              document.body.appendChild(titleInput)
            }
          });
      }
    }
  </script>

</body>

</html>
